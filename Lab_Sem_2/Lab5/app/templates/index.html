<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cărți (cam atât)</title>
    <style>
        body {
            color: black;
            font-family:'Palatino Linotype',serif
        }
        button {
            border: 1px solid #dddddd;
            color: black;
            padding: 5px 10px;
            text-align: center;
            display: block;
            font-size: 16px;
            margin: 2px 2px;
            cursor: pointer;
            width: 175px;
        }
        table
        {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            margin: 2px 2px;
            display: block;
        }
        td, th
        {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }
        label {
            margin: 2px 2px;
            display: inline;
        }
        input {
            margin: 2px 2px;
            display: inline;
        }
    </style>
</head>
<body>
    <h1>
        Database management app
    </h1>
    <button onclick="showCatalog('catalog')">
        Get catalog
    </button>
    <button onclick="showBook('catalog')">
        Get book
    </button>
    <button onclick="deleteBook()">
        Delete book
    </button>
    <form>
        <label for="book_id_input">Book ID:</label>
        <input type="text" id="book_id_input" name="book_id_input" value="0" size="3"><br>
    </form>
    <button onclick="addBook()">
        Add book
    </button>
    <button onclick="updateBook()">
        Update book
    </button>
    <form>
        <label for="book_title">Book title:</label>
        <input type="text" id="book_title" name="book_title" value="" size="20"><br>

        <label for="book_author">Book author:</label>
        <input type="text" id="book_author" name="book_author" value="" size="20"><br>

        <label for="book_release_date">Book release date:</label>
        <input type="text" id="book_release_date" name="book_release_date" value="" size="20"><br>

        <label for="book_stock">Book stock:</label>
        <input type="text" id="book_stock" name="book_stock" value="" size="5">

        <label for="book_price">Book price:</label>
        <input type="text" id="book_price" name="book_price" value="" size="5">
    </form>
    <table id="catalog">
        <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Author</th>
            <th>Year published</th>
            <th>Stock</th>
            <th>Price</th>
        </tr>
    </table>

    <script>

async function getCatalog()
{
    const url = "http://127.0.0.1:5000";
    const response = await fetch(url.concat("/books"));
    return await response.json();
}
async function getBook(bookId)
{
    bookId = Number(bookId)
    if(isNaN(bookId)) {
        alert("Error: Id must be integer!");
        return "error";
    }

    const url = "http://127.0.0.1:5000";
    const response = await fetch(url.concat(`/books/${bookId}`));
    const responseData = await response.json()
    if(response.ok)
        return await responseData;
    else
    {
        alert(responseData['error']);
        return "error"
    }
}
async function clearTable(tableId)
{
    var table = document.getElementById(tableId);
    const tableRowCount = table.rows.length;
    for(let index = 1; index < tableRowCount; index++)
    {
        table.deleteRow(1);
    }
}
async function showBook(tableId) {

    const bookId = document.getElementById("book_id_input").value;

    const bookData = await getBook(bookId);

    if(bookData === "error") {
        return
    }

    await clearTable(tableId);
    const fieldsOrder = bookData[0]['order'];
    const entry = bookData[1];
    addRow(tableId, entry, fieldsOrder);
}
async function showCatalog(tableId)
{
    await clearTable(tableId);
    const catalogData = await getCatalog();

    if(catalogData === "error") {
        return
    }

    const catalogFieldsOrder = catalogData[0]['order'];
    const catalogDataSize = catalogData.length;
    for (let index = 1; index < catalogDataSize; index ++)
    {
        const catalogEntry = catalogData[index];
        addRow(tableId, catalogEntry, catalogFieldsOrder);
    }
}
function addRow(tableId, rowData, catalogFieldsOrder)
{
    var table = document.getElementById(tableId);
    const tableRowCount = table.rows.length;
    var row = table.insertRow(tableRowCount);
    const fieldsCount = Object.keys(catalogFieldsOrder).length;
    for(let index = 0; index < fieldsCount; index ++)
    {
        var cell = row.insertCell(index);
        cell.innerHTML = rowData[catalogFieldsOrder[index]];
    }
}
async function addBook()
{
    let bookTitle = document.getElementById("book_title").value;
    let bookAuthor = document.getElementById("book_author").value;
    let bookReleaseYear = document.getElementById("book_release_date").value;
    let bookStock = document.getElementById("book_stock").value;
    let bookPrice = document.getElementById("book_price").value;

    if(bookTitle === "")
        bookTitle = "-"
    if(bookAuthor === "")
        bookAuthor = "-"
    if(bookReleaseYear === "")
        bookReleaseYear = "-"
    if(bookStock === "")
        bookStock = "-"
    if(bookPrice === "")
        bookPrice = "-"

    const url = "http://127.0.0.1:5000";
    const response = await fetch(url.concat(`/books`),
        {
            method:"POST",
            body: JSON.stringify({title: bookTitle,
                author: bookAuthor, year_published:bookReleaseYear,
                stock: bookStock, price: bookPrice
            }),
            headers:{"Content-type": "application/json; charset=UTF-8"}
            }
        );
    if(response.ok)
    {
        await showCatalog('catalog');
        alert("Added succesfully");
    }
    else
    {
        alert(response[error]);
    }
}

async function updateBook()
{
    let bookId = document.getElementById("book_id_input").value;
    bookId = Number (bookId)
    if(isNaN(bookId)) {
        alert("Error: Id must be integer!");

        return;
    }

    let bookTitle = document.getElementById("book_title").value;
    let bookAuthor = document.getElementById("book_author").value;
    let bookReleaseYear = document.getElementById("book_release_date").value;
    let bookStock = document.getElementById("book_stock").value;
    let bookPrice = document.getElementById("book_price").value;

    let fields = {};
    if(bookTitle !== "")
        fields["title"] = bookTitle;
    if(bookAuthor !== "")
        fields["author"] = bookAuthor;
    if(bookReleaseYear !== "")
        fields["year_published"] = bookReleaseYear;
    if(bookStock !== "")
        fields["stock"] = bookStock;
    if(bookPrice !== "")
        fields["price"] = bookPrice;

    const url = "http://127.0.0.1:5000";
    const response = await fetch(url.concat(`/books/${bookId}`),
        {
            method:"PUT",
            body: JSON.stringify(fields),
            headers:{"Content-type": "application/json; charset=UTF-8"}
        }
    );
    if(response.ok) {
        await showCatalog('catalog');
        const resp = await response.json()
        alert(resp["info"]);
    }
    else
    {
        const resp = await response.json()
        alert(resp["error"]);
    }
}
async function deleteBook()
{
     let bookId = document.getElementById("book_id_input").value;
     bookId = Number (bookId)
     if(isNaN(bookId)) {
        alert("Error: Id must be integer!");
         return;
     }

     const url = "http://127.0.0.1:5000";
     const response = await fetch(url.concat(`/books/${bookId}`),{method:"DELETE"});

     if(response.ok)
     {
         await showCatalog('catalog');
         const resp = await response.json()
         alert(resp["info"]);
     }
     else
     {
         const resp = await response.json()
         alert(resp["error"]);
     }
}
    </script>
</body>
</html>